---
/**
 * Componente reutiliz치vel de dropdown de idiomas
 * Baseado no dropdown usado em translations_languages.astro
 */
import { locales as localesTable } from "../db/schema.ts";
import { db } from "../db/index.ts";

export interface Props {
  /** ID do locale selecionado inicialmente (opcional) */
  selectedLocaleId?: number | null;
  /** Nome do campo hidden que ser치 enviado no formul치rio */
  fieldName?: string;
  /** Se true, o campo 칠 obrigat칩rio */
  required?: boolean;
  /** Quantidade de colunas na lista de idiomas (padr칚o: 3) */
  cols?: number;
}

const { selectedLocaleId = null, fieldName = "id_locale_code", required = false, cols = 3 } = Astro.props;

// Mapear n칰mero de colunas para classes Tailwind v치lidas
const gridColsClass = cols === 1 ? "grid-cols-1" : cols === 2 ? "grid-cols-2" : cols === 3 ? "grid-cols-3" : cols === 4 ? "grid-cols-4" : "grid-cols-3";

// Buscar todos os locales
const allLocales = await db
  .select({
    id: localesTable.id,
    language: localesTable.language,
    hello_world: localesTable.hello_world,
    locale_code: localesTable.locale_code,
    country: localesTable.country,
  })
  .from(localesTable)
  .orderBy(localesTable.language);

const initialLocaleId = selectedLocaleId;
---

<div
  class="dropdown w-full"
  :class="{ 'dropdown-open': localeDropdownOpen }"
  x-on:click.outside="localeDropdownOpen = false"
  x-data="languageDropdown"
>
  <input
    type="hidden"
    name={fieldName}
    x-model="selectedLocaleId"
    {required}
  />
  <label
    tabindex="0"
    class="input input-bordered w-full flex items-center cursor-pointer"
    @click="toggleDropdown()"
  >
    <span
      x-show="selectedLocale"
      class="flex-1 flex items-center gap-2"
    >
      <span
        x-text="selectedLocale ? getFlagEmoji(selectedLocale.locale_code) : ''"
      ></span>
      <span
        x-text="selectedLocale ? selectedLocale.language : 'Selecione um idioma'"
      ></span>
    </span>
    <span x-show="!selectedLocale" class="flex-1 text-base-content/50">
      Selecione um idioma
    </span>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5 shrink-0"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M19 9l-7 7-7-7"></path>
    </svg>
  </label>
  <div
    tabindex="0"
    class="dropdown-content bg-base-100 rounded-box z-10 w-full border border-base-300 p-2 shadow-lg mt-1 max-h-96 overflow-y-auto"
    x-show="localeDropdownOpen"
    x-transition
  >
    <div class="w-full mb-2">
      <input
        type="text"
        placeholder="Buscar idioma..."
        class="input input-bordered input-sm w-full"
        x-model="localeSearch"
        @click.stop
        @keydown.escape="localeDropdownOpen = false"
      />
    </div>
    <div class={`grid ${gridColsClass} gap-2`}>
      <template x-for="locale in filteredLocales" :key="locale.id">
        <a
          href="#"
          @click.prevent="selectLocale(locale.id)"
          class="grid grid-cols-[auto_1fr] gap-2 py-2 px-2 items-center rounded hover:bg-base-200 transition-colors"
        >
          <span
            class="text-2xl shrink-0"
            x-text="getFlagEmoji(locale.locale_code)"></span>
          <div class="flex flex-col flex-1 min-w-0">
            <span class="font-medium text-sm" x-text="locale.language"
            ></span>
            <span
              class="text-xs text-base-content/60"
              x-text="locale.hello_world"></span>
          </div>
        </a>
      </template>
    </div>
    <div
      x-show="filteredLocales.length === 0"
      class="text-base-content/50 text-sm py-2 px-4 text-center col-span-2"
    >
      Nenhum idioma encontrado
    </div>
  </div>
</div>

<script
  define:vars={{
    initialLocaleId,
    localesData: JSON.stringify(allLocales),
  }}
>
  document.addEventListener("alpine:init", () => {
    window.Alpine.data("languageDropdown", () => {
      const locales = JSON.parse(localesData);
      return {
        selectedLocaleId: initialLocaleId,
        localeSearch: "",
        localeDropdownOpen: false,
        locales: locales,
        get filteredLocales() {
          if (!this.localeSearch.trim()) return this.locales;
          const search = this.localeSearch.toLowerCase();
          return this.locales.filter(
            (locale) =>
              locale.language.toLowerCase().includes(search) ||
              locale.country.toLowerCase().includes(search) ||
              locale.locale_code.toLowerCase().includes(search) ||
              locale.hello_world.toLowerCase().includes(search),
          );
        },
        get selectedLocale() {
          return this.locales.find((l) => l.id === this.selectedLocaleId);
        },
        selectLocale(localeId) {
          this.selectedLocaleId = localeId;
          this.localeSearch = "";
          this.localeDropdownOpen = false;
        },
        toggleDropdown() {
          this.localeDropdownOpen = !this.localeDropdownOpen;
        },
        getFlagEmoji(localeCode) {
          const flagMap = {
            en: "游쥟릖",
            "en-gb": "游섫릖",
            "pt-br": "游游",
            pt_br: "游游",
            "pt-pt": "游왫릖",
            es: "游쀯릖",
            "es-mx": "游쓇릖",
            fr: "游游",
            "fr-ca": "游뻟릖",
            de: "游뾇릖",
            it: "游쉻릖",
            ja: "游游",
            "zh-cn": "游뻟릖",
            "zh-tw": "游좷릖",
            ru: "游游",
            ko: "游썷릖",
            ar: "游젏릖",
            nl: "游游",
            pl: "游왫릖",
            tr: "游좷릖",
            vi: "游游",
            hi: "游쉻릖",
            th: "游좷릖",
            id: "游쉻릖",
            he: "游쉻릖",
            el: "游섫릖",
            sv: "游젏릖",
            no: "游游",
            da: "游뾇릖",
            fi: "游游",
            cs: "游뻟릖",
            ro: "游游",
            hu: "游쇓릖",
            uk: "游쥟릖",
            bg: "游游",
            hr: "游쇓릖",
            sr: "游游",
            sk: "游젏릖",
            sl: "游젏릖",
          };
          const code = localeCode.toLowerCase().replace(/_/g, "-");
          const codeParts = code.split("-");
          const baseCode = codeParts[0] || code;
          return flagMap[code] || flagMap[baseCode] || "游깷";
        },
      };
    });
  });
</script>
