---
/**
 * Modal de adição de termo de taxonomia. Deve ser renderizado fora do form
 * principal (ex.: após </form>) para evitar form aninhado. O script em
 * TaxonomiesBlocks preenche parent_id, type e label ao abrir via [data-taxonomy-add].
 */
import { Icon } from "astro-icon/components";
import { t } from "../i18n/index.ts";

interface Props {
  locale: string;
}

const { locale } = Astro.props;
---
<input type="checkbox" id="taxonomy-add-modal-toggle" class="modal-toggle" />
<div class="modal" role="dialog">
  <div class="modal-box relative">
    <label
      for="taxonomy-add-modal-toggle"
      class="btn btn-ghost btn-sm btn-circle absolute right-2 top-2"
      aria-label={t(locale, "admin.taxonomy.modalClose")}
    >
      <Icon name="line-md:close" size={20} aria-hidden="true" />
    </label>
    <form
      id="taxonomy-add-form"
      method="post"
      action="/api/taxonomies"
      class="flex flex-col gap-3 pt-6"
    >
      <input type="hidden" name="parent_id" id="taxonomy-form-parent-id" value="" />
      <input type="hidden" name="type" id="taxonomy-form-type" value="" />
      <input type="hidden" name="locale" value={locale} />
      <div class="form-control">
        <label for="taxonomy-form-name" class="label" id="taxonomy-modal-label"></label>
        <input
          type="text"
          id="taxonomy-form-name"
          name="name"
          required
          class="input input-bordered input-sm w-full"
        />
      </div>
      <div id="taxonomy-modal-error-container" class="min-h-6"></div>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary btn-sm">
          {t(locale, "admin.taxonomy.addButton")}
        </button>
      </div>
    </form>
  </div>
  <label class="modal-backdrop" for="taxonomy-add-modal-toggle">{t(locale, "admin.taxonomy.modalClose")}</label>
</div>

<script>
  interface TaxonomyApiResponse {
    success?: boolean;
    taxonomy?: { id: number; name: string; slug: string };
  }

  // Função auxiliar para escapar HTML (escopo local)
  function escapeHtml(text: string): string {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  // Handler para o evento taxonomy-added: atualiza a lista no accordion e fecha o modal
  function handleTaxonomyAdded(event: Event) {
    const customEvent = event as CustomEvent<{ id: number; name: string; slug: string; parent_id: number | null }>;
    const { id, name, parent_id } = customEvent.detail;

    const list = document.getElementById(`taxonomy-list-${parent_id}`);
    if (!list) return;

    const li = document.createElement("li");
    li.innerHTML = `
      <label class="label cursor-pointer justify-start gap-2 py-1">
        <input
          type="checkbox"
          name="taxonomy_terms[]"
          value="${id}"
          class="checkbox checkbox-sm checkbox-primary"
        />
        <span class="label-text">${escapeHtml(name)}</span>
      </label>
    `;
    list.appendChild(li);

    const modalToggle = document.getElementById("taxonomy-add-modal-toggle") as HTMLInputElement;
    if (modalToggle) modalToggle.checked = false;

    const form = document.getElementById("taxonomy-add-form") as HTMLFormElement;
    if (form) {
      form.reset();
      const errorContainer = document.getElementById("taxonomy-modal-error-container");
      if (errorContainer) errorContainer.innerHTML = "";
    }
  }

  document.body.addEventListener("taxonomy-added", handleTaxonomyAdded);

  // Submit via fetch para não redirecionar; em sucesso dispara taxonomy-added e fecha o modal
  const form = document.getElementById("taxonomy-add-form") as HTMLFormElement;
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const target = e.currentTarget as HTMLFormElement;
    const action = target.getAttribute("action") || "/api/taxonomies";
    const errorContainer = document.getElementById("taxonomy-modal-error-container");
    const submitBtn = target.querySelector('button[type="submit"]') as HTMLButtonElement;
    const parentIdInput = document.getElementById("taxonomy-form-parent-id") as HTMLInputElement;
    const parentIdVal = parentIdInput?.value?.trim();
    const parent_id =
      parentIdVal && /^\d+$/.test(parentIdVal) ? parseInt(parentIdVal, 10) : null;

    if (submitBtn) submitBtn.disabled = true;
    if (errorContainer) errorContainer.innerHTML = "";

    try {
      const res = await fetch(action, {
        method: "POST",
        body: new FormData(target),
      });
      const contentType = res.headers.get("Content-Type") || "";

      if (contentType.includes("application/json")) {
        const data = (await res.json()) as TaxonomyApiResponse;
        if (data.success && data.taxonomy) {
          document.body.dispatchEvent(
            new CustomEvent("taxonomy-added", {
              detail: {
                id: data.taxonomy.id,
                name: data.taxonomy.name,
                slug: data.taxonomy.slug,
                parent_id,
              },
            })
          );
          return;
        }
      }

      const html = await res.text();
      if (errorContainer) errorContainer.innerHTML = html;
    } catch (err) {
      if (errorContainer) {
        errorContainer.innerHTML = '<p class="text-error text-sm mt-2">Erro de conexão.</p>';
      }
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  });
</script>
