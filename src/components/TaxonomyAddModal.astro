---
/**
 * Modal de adição de termo de taxonomia. Deve ser renderizado fora do form
 * principal (ex.: após </form>) para evitar form aninhado. O script em
 * TaxonomiesBlocks preenche parent_id, type e label ao abrir via [data-taxonomy-add].
 */
import { Icon } from "astro-icon/components";
import { t } from "../i18n/index.ts";

interface Props {
  locale: string;
}

const { locale } = Astro.props;
---
<input type="checkbox" id="taxonomy-add-modal-toggle" class="modal-toggle" />
<div class="modal" role="dialog">
  <div class="modal-box relative">
    <label
      for="taxonomy-add-modal-toggle"
      class="btn btn-ghost btn-sm btn-circle absolute right-2 top-2"
      aria-label={t(locale, "admin.taxonomy.modalClose")}
    >
      <Icon name="line-md:close" size={20} aria-hidden="true" />
    </label>
    <form
      id="taxonomy-add-form"
      method="post"
      action="/api/taxonomies"
      hx-post="/api/taxonomies"
      hx-target="#taxonomy-modal-error-container"
      hx-swap="innerHTML"
      class="flex flex-col gap-3 pt-6"
    >
      <input type="hidden" name="parent_id" id="taxonomy-form-parent-id" value="" />
      <input type="hidden" name="type" id="taxonomy-form-type" value="" />
      <input type="hidden" name="locale" value={locale} />
      <div class="form-control">
        <label for="taxonomy-form-name" class="label" id="taxonomy-modal-label"></label>
        <input
          type="text"
          id="taxonomy-form-name"
          name="name"
          required
          class="input input-bordered input-sm w-full"
        />
      </div>
      <div id="taxonomy-modal-error-container" class="min-h-6"></div>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary btn-sm">
          {t(locale, "admin.taxonomy.addButton")}
        </button>
      </div>
    </form>
  </div>
  <label class="modal-backdrop" for="taxonomy-add-modal-toggle">{t(locale, "admin.taxonomy.modalClose")}</label>
</div>

<script>
  // Handler para o evento taxonomy-added
  function handleTaxonomyAdded(event: Event) {
    const customEvent = event as CustomEvent<{ id: number; name: string; slug: string; parent_id: number | null }>;
    const { id, name, parent_id } = customEvent.detail;
    
    // Função auxiliar para escapar HTML (escopo local)
    const escapeHtml = (text: string): string => {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    };
    
    // Encontra a lista correspondente ao parent_id
    const list = document.getElementById(`taxonomy-list-${parent_id}`);
    if (!list) return;
    
    // Cria o novo item da lista
    const li = document.createElement("li");
    li.innerHTML = `
      <label class="label cursor-pointer justify-start gap-2 py-1">
        <input
          type="checkbox"
          name="taxonomy_terms[]"
          value="${id}"
          class="checkbox checkbox-sm checkbox-primary"
        />
        <span class="label-text">${escapeHtml(name)}</span>
      </label>
    `;
    
    // Insere o novo item na lista (mantém ordem alfabética seria ideal, mas por simplicidade adiciona no final)
    list.appendChild(li);
    
    // Fecha o modal
    const modalToggle = document.getElementById("taxonomy-add-modal-toggle") as HTMLInputElement;
    if (modalToggle) modalToggle.checked = false;
    
    // Limpa o formulário
    const form = document.getElementById("taxonomy-add-form") as HTMLFormElement;
    if (form) {
      form.reset();
      const errorContainer = document.getElementById("taxonomy-modal-error-container");
      if (errorContainer) errorContainer.innerHTML = "";
    }
  }
  
  // Escuta o evento taxonomy-added disparado pela API quando um novo termo é criado
  document.body.addEventListener("taxonomy-added", handleTaxonomyAdded);
  
  // Intercepta a resposta do HTMX para tratar JSON e HTML separadamente
  document.getElementById("taxonomy-add-form")?.addEventListener("htmx:after-request", (event: any) => {
    const xhr = event.detail.xhr;
    if (!xhr) return;
    
    const contentType = xhr.getResponseHeader("Content-Type") || "";
    
    // Se a resposta for JSON (sucesso), limpa o container de erro
    // O evento taxonomy-added já foi disparado pelo header HX-Trigger
    if (contentType.includes("application/json")) {
      try {
        const data = JSON.parse(xhr.responseText);
        if (data.success && data.taxonomy) {
          const errorContainer = document.getElementById("taxonomy-modal-error-container");
          if (errorContainer) errorContainer.innerHTML = "";
        }
      } catch (e) {
        // Se não conseguir fazer parse do JSON, pode ser que seja HTML de erro
        // Nesse caso, o HTMX já fez o swap normalmente
      }
    }
  });
  
  // Previne swap quando a resposta for JSON
  document.getElementById("taxonomy-add-form")?.addEventListener("htmx:before-swap", (event: any) => {
    const xhr = event.detail.xhr;
    if (!xhr) return;
    
    const contentType = xhr.getResponseHeader("Content-Type") || "";
    if (contentType.includes("application/json")) {
      // Cancela o swap para respostas JSON
      event.detail.shouldSwap = false;
    }
  });
</script>
